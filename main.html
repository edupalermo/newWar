<!DOCTYPE html>
<html>

<head>

<script>

var mainCanvasContext;

var transformMatrix = {
  a : 1,
  b : 0,
  c : 0,
  d : 1,
  e : 0,
  f : 0
};

function handleOnLoad() {
  console.log("Carregou!");
  mainCanvasContext = getMainCanvasContext();
  test();
}

function test() {
  var canvas = document.getElementById("temporaryCanvas");
  var ctx = canvas.getContext("2d");

  ctx.fillStyle = "white";
  ctx.fillRect(0, 0, ctx.canvas.clientWidth, ctx.canvas.clientHeight);

  ctx.fillStyle = "#FF0000";
  ctx.fillRect(50, 50, 150, 75);

  var i = 0;

  for (i = 0; i < 10000; i++) {
    ctx.beginPath();
    ctx.arc(Math.random() * ctx.canvas.clientWidth, Math.random() * ctx.canvas.clientHeight, Math.random() * 30, 0, 2 * Math.PI);
    ctx.fillStyle = `rgb(
        ${random(256)},
        ${random(256)},
        ${random(256)})`
    ctx.fill();
  }

  ctx.beginPath();
  ctx.lineWidth = "6";
  ctx.strokeStyle = "red";
  ctx.rect(0, 0, ctx.canvas.clientWidth, ctx.canvas.clientHeight);
  ctx.stroke();

  copy();
}

function copy() {
  var sourceCanvas = document.getElementById("temporaryCanvas");

  // console.log(mainCanvasContext.currentTransform);
  //call its drawImage() function passing it the source canvas directly
  mainCanvasContext.drawImage(sourceCanvas, 0, 0);

}

function getMainCanvasContext() {
  var canvas = document.getElementById("mainCanvas");
  return canvas.getContext('2d');
}

function handleOnMouseWheel(event) {
  event.preventDefault();

  var rect = event.target.getBoundingClientRect();
  var shiftX = (Math.abs(transformMatrix.e) + (event.x - rect.x)) / transformMatrix.a;
  var shiftY = (Math.abs(transformMatrix.f) + (event.y - rect.y)) / transformMatrix.d;


  if (event.wheelDelta > 0) {
    transformMatrix.a = transformMatrix.a * 1.1;
    transformMatrix.d = transformMatrix.d * 1.1;
  }
  else {
    transformMatrix.a = Math.max(transformMatrix.a / 1.1, 1);
    transformMatrix.d = Math.max(transformMatrix.d / 1.1, 1);
  }

  transformMatrix.e = (event.x - rect.x) - (shiftX * transformMatrix.a);
  transformMatrix.f = (event.y - rect.y) - (shiftY * transformMatrix.d);



  constraintTransformMatrix();
  mainCanvasContext.setTransform(transformMatrix);
  copy();

  //console.log("WHEEL!" + transformMatrix.a);
}

var dragging = 0;
var dragReference = {
  x : 0,
  y : 0,
  e : 0,
  f : 0
}

function bounded(min, value, max) {
  return Math.max(Math.min(value, max), min);
}

function constraintTransformMatrix() {

  var min = mainCanvasContext.canvas.clientWidth - (mainCanvasContext.canvas.clientWidth * transformMatrix.a);
  transformMatrix.e = bounded(min, transformMatrix.e, 0);

  var min = mainCanvasContext.canvas.clientHeight - (mainCanvasContext.canvas.clientHeight * transformMatrix.d);
  transformMatrix.f = bounded(min, transformMatrix.f, 0);

}
function handleOnMouseMove(event) {

  if (dragging && event.buttons == 1) {
    // Horizntal moving
    transformMatrix.e = dragReference.e + event.x - dragReference.x;

    // Vertical moving
    transformMatrix.f = dragReference.f + event.y - dragReference.y;

    constraintTransformMatrix();

    mainCanvasContext.setTransform(transformMatrix);
    copy();
  }

  // console.log("e, f: " + (transformMatrix.e) + ", " + (transformMatrix.f));
}

function random(number) {
  return Math.floor(Math.random() * number);
}

function handleOnMouseDown(event) {

  dragReference.x = event.x;
  dragReference.y = event.y;
  dragReference.e = transformMatrix.e;
  dragReference.f = transformMatrix.f;

  dragging = 1;
}

function handleOnMouseUp(event) {
  dragging = 0;
}

</script>

</head>


<body onload="handleOnLoad()">


<canvas id="temporaryCanvas" width="600" height="400" style="border:1px solid #c3c3c3;">
Your browser does not support the canvas element.
</canvas>

<canvas id="mainCanvas" width="600" height="400" style="border:1px solid #c3c3c3;"
  onmousemove="handleOnMouseMove(event)"
  onmousewheel="handleOnMouseWheel(event)"
  onmousedown="handleOnMouseDown(event)"
  onmouseup="handleOnMouseUp(event)">
Your browser does not support the canvas element.
</canvas>

</body>

</html>
